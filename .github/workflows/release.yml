# VerShip ìë™ ë¦´ë¦¬ì¦ˆ ì›Œí¬í”Œë¡œìš°
# 
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main ë¸Œëœì¹˜ì— ì»¤ë°‹ì´ í‘¸ì‹œë  ë•Œë§ˆë‹¤:
# 1. ë¦´ë¦¬ì¦ˆê°€ í•„ìš”í•œì§€ í™•ì¸í•˜ê³ 
# 2. í•„ìš”í•œ ê²½ìš° ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤

name: ğŸš€ Release

on:
  push:
    branches: [main, master]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

jobs:
  # Step 1: ë¦´ë¦¬ì¦ˆ í•„ìš” ì—¬ë¶€ í™•ì¸
  check-release:
    name: ğŸ“‹ ë¦´ë¦¬ì¦ˆ ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      needs_release: ${{ steps.check.outputs.needs_release }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ Git íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” ë¦´ë¦¬ì¦ˆ ìƒíƒœ í™•ì¸
        id: check
        run: |
          # vership statusë¥¼ JSONìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ê²°ê³¼ íŒŒì‹±
          STATUS=$(npx tsx src/cli.ts status --output=json)
          echo "ìƒíƒœ í™•ì¸ ê²°ê³¼: $STATUS"
          
          NEEDS_RELEASE=$(echo $STATUS | jq -r '.needsRelease // false')
          CURRENT_VERSION=$(echo $STATUS | jq -r '.currentVersion // "unknown"')
          
          echo "needs_release=$NEEDS_RELEASE" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ë¦´ë¦¬ì¦ˆ í•„ìš”: $NEEDS_RELEASE"
          echo "ğŸ“‹ í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

  # Step 2: ì‹¤ì œ ë¦´ë¦¬ì¦ˆ ìˆ˜í–‰
  release:
    name: ğŸš€ íŒ¨í‚¤ì§€ ë°°í¬
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.needs_release == 'true'
    permissions:
      contents: write # GitHub Release ìƒì„±ì„ ìœ„í•´ í•„ìš”
      packages: write # GitHub Packages ë°°í¬ì‹œ í•„ìš” (ì„ íƒì‚¬í•­)
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ”§ Git ì‚¬ìš©ì ì„¤ì •
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test
        continue-on-error: false

      - name: ğŸ”¨ ë¹Œë“œ ì‹¤í–‰ (ìˆëŠ” ê²½ìš°)
        run: |
          if npm run build --if-present; then
            echo "âœ… ë¹Œë“œ ì™„ë£Œ"
          else
            echo "â„¹ï¸  ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: ğŸš€ ë°°í¬ ì‹¤í–‰
        run: npx tsx src/cli.ts publish --ci --skip-confirm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“¦ ë²„ì „: ${{ needs.check-release.outputs.current_version }}"

  # Step 3: ë°°í¬ ì‹¤íŒ¨ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-failure:
    name: âŒ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [check-release, release]
    if: failure() && needs.check-release.outputs.needs_release == 'true'
    steps:
      - name: ğŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "âŒ ë°°í¬ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
          # ì—¬ê¸°ì— Slack, Discord ë“±ì˜ ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
