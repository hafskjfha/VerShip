import fs from 'fs/promises';
import path from 'path';
import { ChangelogConfig } from './changelog.js';

export interface ChangelogTemplateInfo {
  id: string;
  name: string;
  description: string;
  preview: string;
}

export class ChangelogConfigManager {
  private cwd: string;
  private configPath: string;
  
  constructor(cwd = process.cwd()) {
    this.cwd = cwd;
    this.configPath = path.join(cwd, '.changesets', 'changelog.json');
  }
  
  /**
   * ì²´ì¸ì§€ë¡œê·¸ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤
   */
  async loadConfig(): Promise<ChangelogConfig> {
    try {
      const content = await fs.readFile(this.configPath, 'utf-8');
      return JSON.parse(content);
    } catch {
      // ê¸°ë³¸ ì„¤ì • ë°˜í™˜
      return {
        template: 'default',
        includeCommitLinks: false,
        includeAuthor: false,
        includePR: false,
        categories: {
          major: 'ğŸ’¥ Breaking Changes',
          minor: 'ğŸš€ Features',
          patch: 'ğŸ› Bug Fixes'
        }
      };
    }
  }
  
  /**
   * ì²´ì¸ì§€ë¡œê·¸ ì„¤ì •ì„ ì €ì¥í•©ë‹ˆë‹¤
   */
  async saveConfig(config: ChangelogConfig): Promise<void> {
    try {
      await fs.mkdir(path.dirname(this.configPath), { recursive: true });
      await fs.writeFile(this.configPath, JSON.stringify(config, null, 2));
    } catch (error) {
      throw new Error(`ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${error instanceof Error ? error.message : error}`);
    }
  }
  
  /**
   * ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤
   */
  getAvailableTemplates(): ChangelogTemplateInfo[] {
    return [
      {
        id: 'default',
        name: 'ê¸°ë³¸ í…œí”Œë¦¿',
        description: 'í•œêµ­ì–´ ì´ëª¨ì§€ê°€ í¬í•¨ëœ ê¸°ë³¸ í…œí”Œë¦¿',
        preview: `## v1.0.0 (2025-08-28)

### ğŸ’¥ Breaking Changes
- API ì¸í„°í˜ì´ìŠ¤ ë³€ê²½

### ğŸš€ Features  
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€

### ğŸ› Bug Fixes
- ë²„ê·¸ ìˆ˜ì •`
      },
      {
        id: 'github',
        name: 'GitHub ìŠ¤íƒ€ì¼',
        description: 'GitHub Releases ìŠ¤íƒ€ì¼ í…œí”Œë¦¿ (ë§í¬ í¬í•¨)',
        preview: `## [v1.0.0](https://github.com/owner/repo/compare/v1.0.0) (2025-08-28)

### ğŸ’¥ Breaking Changes
- API ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ by @author ([#123](https://github.com/owner/repo/pull/123))

### ğŸš€ New Features
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ by @author ([#124](https://github.com/owner/repo/pull/124))`
      },
      {
        id: 'conventional',
        name: 'Conventional Commits',
        description: 'Conventional Commits í‘œì¤€ì„ ë”°ë¥´ëŠ” í…œí”Œë¦¿',
        preview: `## [1.0.0](https://github.com/owner/repo/compare/v1.0.0) (2025-08-28)

### âš  BREAKING CHANGES
* API ì¸í„°í˜ì´ìŠ¤ ë³€ê²½

### Features
* ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€

### Bug Fixes
* ë²„ê·¸ ìˆ˜ì •`
      },
      {
        id: 'custom',
        name: 'ì»¤ìŠ¤í…€ í…œí”Œë¦¿',
        description: 'ì‚¬ìš©ì ì •ì˜ Handlebars í…œí”Œë¦¿',
        preview: 'ì‚¬ìš©ìê°€ ì •ì˜í•œ í…œí”Œë¦¿ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.'
      }
    ];
  }
  
  /**
   * ìƒ˜í”Œ ì»¤ìŠ¤í…€ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤
   */
  async createSampleCustomTemplate(): Promise<string> {
    const templatePath = path.join(this.cwd, '.changesets', 'changelog-template.hbs');
    
    const sampleTemplate = `# ğŸ“‹ Change Log

## ğŸ·ï¸ Version {{version}} - {{dateFormat date 'long'}}

{{#if repository}}
**Full Changelog**: [{{repository.owner}}/{{repository.name}}]({{compareUrl}})
{{/if}}

{{#if changes.major}}
## ğŸ’¥ Breaking Changes

{{#each changes.major}}
- **{{summary}}**
  {{#if author}}- ì‘ì„±ì: @{{author}}{{/if}}
  {{#if pr}}- Pull Request: [#{{pr}}]({{prUrl pr}}){{/if}}
{{/each}}

{{/if}}
{{#if changes.minor}}
## âœ¨ New Features

{{#each changes.minor}}
- {{summary}}
  {{#if author}}- by @{{author}}{{/if}}
  {{#if pr}} ([#{{pr}}]({{prUrl pr}})){{/if}}
{{/each}}

{{/if}}
{{#if changes.patch}}
## ğŸ”§ Bug Fixes & Improvements

{{#each changes.patch}}
- {{summary}}
  {{#if author}}- by @{{author}}{{/if}}
  {{#if pr}} ([#{{pr}}]({{prUrl pr}})){{/if}}
{{/each}}

{{/if}}

---
*Generated by VerShip ğŸš€*
`;

    try {
      await fs.mkdir(path.dirname(templatePath), { recursive: true });
      await fs.writeFile(templatePath, sampleTemplate);
      return templatePath;
    } catch (error) {
      throw new Error(`ìƒ˜í”Œ í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨: ${error instanceof Error ? error.message : error}`);
    }
  }
  
  /**
   * ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤
   */
  async updateConfig(updates: Partial<ChangelogConfig>): Promise<ChangelogConfig> {
    const currentConfig = await this.loadConfig();
    const newConfig = { ...currentConfig, ...updates };
    await this.saveConfig(newConfig);
    return newConfig;
  }
  
  /**
   * ì„¤ì •ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤
   */
  async resetConfig(): Promise<void> {
    try {
      await fs.unlink(this.configPath);
    } catch {
      // íŒŒì¼ì´ ì—†ì–´ë„ ë¬´ì‹œ
    }
  }
}
